<!doctype html>
<html lang='en'>
  <head>
    <meta name='twitter:card' content='summary' />
    <meta property='og:title' content='Making an Authorized Request to the E*TRADE API with OkHttp' />
    <meta property='og:url' content='https://seansoper.com/blog/make_authorized_request_etrade_api_okhttp.html' />
    <meta property='og:description' content='While the default Java HttpClient is just fine for simple requests, we will be interacting with an OAuth v1 powered endpoint which will require requests to be signed. We shouldn‚Äôt have to worry about all those details and for that the OkHttp library fits our needs perfectly.' />
    <meta property='og:image' content='//source.unsplash.com/gaAopnw13EA/1200x627' />
    <!-- Generated by zebec https://github.com/ssoper/Zebec -->
    <meta charset='utf-8' />
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no' />
    <meta name='ICBM' content='39.0840, 77.1528' />
    <title>eat. code. stocks.</title>
    <link type='image/x-icon' href='/favicon.ico' rel='shortcut icon' />
    <link type='application/rss+xml' title='eat. code. stocks.' href='/blog/rss.xml' rel='alternate' />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js'></script>
      <script src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js'></script>
    <![endif]-->
  </head>
  <body>
    <!-- Navigation -->
    <nav class='navbar navbar-expand-lg navbar-dark bg-dark fixed-top'>
      <div class='container'>
        <a class='navbar-brand' title='eat. code. stocks.' href='/blog'>üç± üë®üèª‚Äçüíª üè¶</a>
        <button class='navbar-toggler' type='button' data-toggle='collapse' data-target='#navbarResponsive' aria-controls='navbarResponsive' aria-expanded='false' aria-label='Toggle navigation'>
          <span class='navbar-toggler-icon'></span>
        </button>
        <div class='collapse navbar-collapse' id='navbarResponsive'>
          <ul class='navbar-nav ml-auto'>
            <li class='nav-item'>
              <a class='nav-link' href='/'>Home</a>
            </li>
            <li class='nav-item'>
              <a class='nav-link' href='/blog'>Blog</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Page Content -->
    <div class='container'>
      <div class='row'>
        <div class='col-lg-8 content'>
          <h1 class='mt-4'>Making an Authorized Request to the E*TRADE API with OkHttp</h1><h2 class='subtitle'>Create an OAuth v1 request using a custom interceptor</h2><div class='author'>
  <img src='/images/avatar_normal.jpg' alt='' srcset='/images/avatar_normal.jpg 1x, /images/avatar_retina.jpg 2x'/>
  <ul>
    <li>Sean Soper</li>
    <li>October 20, 2020</li>
  </ul>
</div><img class='img-fluid rounded' alt='' src='//source.unsplash.com/gaAopnw13EA/900x300' srcset='//source.unsplash.com/gaAopnw13EA/900x300 1x, //source.unsplash.com/gaAopnw13EA/1800x600 2x'><p>While the default Java <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html">HttpClient</a> is just fine for simple requests, we will be interacting with an OAuth v1 powered endpoint which will require requests to be signed. We shouldn‚Äôt have to worry about all those details and for that the <a href="https://square.github.io/okhttp/">OkHttp</a> library fits our needs perfectly.</p><blockquote><p>This post builds on work previously done in <a href="/blog/reading_yaml_configuration_file_kotlin.html">Reading a YAML Configuration File in Kotlin</a>.</p></blockquote><h2>OkHttp</h2><p>First we are going to bring in <a href="https://square.github.io/okhttp/">OkHttp</a> which we will use as a base on which to build our HTTP client.</p><pre><code>
# build.gradle.kts

dependencies {
  ‚Ä¶
  implementation(&quot;com.squareup.okhttp3:okhttp:4.9.0&quot;)
}     
</code></pre><p>OkHttp implements the <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder pattern</a> which is straight out of GoF‚Äôs <a href="https://en.wikipedia.org/wiki/Design_Patterns">Design Patterns</a>. We can verify the new dependency works with a simple example.</p><pre><code>
val client = OkHttpClient.Builder().build()
        
val request = Request.Builder()
        .url(&quot;https://www.google.com&quot;)
        .build()
        
val response = client.newCall(request).execute()

response.body?.let { 
    println(it.string())
}
</code></pre><h2>Intercept</h2><p>One of the <em>many</em> great things about the OkHttp library is its extensibility particularly the ease with which we can add an <a href="https://square.github.io/okhttp/interceptors/">interceptor</a>. In our case, we will need an Oauth v1 interceptor which can sign our requests with the E*TRADE supplied keys we received. Fortunately, most of the hard work has been done for us. This <a href="https://gist.github.com/ssoper/30b92aad67a36facbc8974aab8ee865f">interceptor</a>, which I updated to work with E*TRADE endpoints, was forked off the <a href="https://gist.github.com/polson/227e1a039a09f2728163bf7235990178">Kotlin version</a> of an <a href="https://gist.github.com/JakeWharton/f26f19732f0c5907e1ab">OAuth v1 interceptor</a> originally written by <a href="https://twitter.com/JakeWharton">Jake Wharton</a>.</p><p>But rather than just dump all our code in the root of our project, we are going to create a <em>package</em>. With an eye towards supporting more than one broker in the future it makes sense to organize and componentize it for ease of maintenance.</p><img src="/images/blog/make_authorized_request_etrade_api_okhttp/package.png" alt="Package Screenshot" class="img-fluid rounded embedded">
<p>We are going to name our package <code>connectors</code> and when you add a new file/class within this package you will notice that the <code>package</code> identifier at the top of the file will be automatically set to the correct value. Any files in your project that make use of a class in the package will need to reference the full package name. Let‚Äôs go ahead and add  <a href="https://github.com/ssoper/Batil/compare/3621d1..4ce8af7d#diff-55026f9c4d29af5bb2da0dc3a2443162d9edbdcc133fa352c9ba47f1c62fc0c2">Etrade.kt</a> and <a href="https://github.com/ssoper/Batil/compare/3621d1..4ce8af7d#diff-45fa7f853a7eb393636dff3376814cdeedf1323472b7aaf251b40818b4448da7">EtradeInterceptor.kt</a> to our new package.</p><p>With the <code>Interceptor</code> doing the heavy lifting of signing our requests, we can focus on crafting the correct URL request to get our OAuth tokens. While additional work would be required to <a href="https://github.com/ssoper/Batil/compare/3621d1..4ce8af7d#diff-55026f9c4d29af5bb2da0dc3a2443162d9edbdcc133fa352c9ba47f1c62fc0c2R71">parse</a> the URL-encoded response, here is what the base functionality would look like.</p><pre><code>
val keys = OauthKeys(
    consumerKey = consumerKey,
    consumerSecret = consumerSecret
)

val client = OkHttpClient.Builder()
    .addInterceptor(EtradeInterceptor(keys))
    .build()
    
val request = Request.Builder()
    .url(&quot;https://apisb.etrade.com/oauth/request_token&quot;)
    .build()
     
val response = client.newCall(request).execute()
</code></pre><h2>Tokens</h2><p>With our consumer keys stored in our <a href="/blog/reading_yaml_configuration_file_kotlin.html">YAML file</a> for easy retrieval, we can pass them along to our HTTP client and get back the OAuth tokens required for the next step in our journey.</p><pre><code>
val client = Etrade(configuration, parsed.production)

client.requestToken().apply {
    println(&quot;Token: $accessToken, secret: $accessSecret&quot;)
}
</code></pre><p>A summary of these commits can be found <a href="https://github.com/ssoper/Batil/compare/3621d1..4ce8af7d">here</a>.</p>
        </div>
        <!-- Sidebar Widgets Column -->
        <div class='col-md-4'>
          <!-- Search Widget -->
          <div class='card my-4'>
            <h5 class='card-header'>Search</h5>
            <div class='card-body'>
              <div class='input-group'>
                <input class='form-control' placeholder='Search for‚Ä¶' id='search-query' type='text' />
                <span class='input-group-btn'>
                  <button class='btn btn-secondary' type='button' id='search-button'>Go!</button>
                </span>
              </div>
            </div>
          </div>
          <a href='/blog/rss.xml'><img width='72' src='https://shields.io/badge/rss-2.0-blue?logo=rss'></a>
        </div>
      </div>
    </div>
    <!-- jQuery -->
    <script integrity='sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n' crossorigin='anonymous' src='https://code.jquery.com/jquery-3.4.1.slim.min.js'></script>
    <!-- Popper -->
    <script integrity='sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo' crossorigin='anonymous' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
    <!-- Bootstrap -->
    <script integrity='sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6' crossorigin='anonymous' src='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js'></script>
    <!-- highlight.js -->
    <script src='//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js'></script>
    <!-- Delay loading of some assets for Google PageSpeed optimizations -->
    <noscript id='deferred-styles'>
      <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' integrity='sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh' crossorigin='anonymous' rel='stylesheet' />
      <link href='/css/blog.min.css' rel='stylesheet' />
      <link href='//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/default.min.css' rel='stylesheet' />
    </noscript>
    <script src='/js/load_deferred_styles.min.js'></script>
    <script src='/js/load_highlight.min.js'></script>
    <script src='/js/load_search.min.js'></script>
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    if (typeof(ga) === 'function') { ga('create', 'UA-616637-1', 'auto'); ga('send', 'pageview'); }
    </script>
  </body>
</html>