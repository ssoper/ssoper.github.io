<!doctype html>
<html lang='en'>
  <head>
    <meta name='twitter:card' content='summary' />
    <meta property='og:title' content='Using Retrofit to Integrate with an API' />
    <meta property='og:url' content='https://seansoper.com/blog/using_retrofit_integrate_api.html' />
    <meta property='og:description' content='Integrating against an API involves a fair amount of work, especially if you want to do more than the bare minimum like including tests. Thanks to tools like Retrofit, OkHttp and their suite of plugins, this task becomes much more manageable.' />
    <meta property='og:image' content='//source.unsplash.com/EYKW9T91_zw/1200x627' />
    <!-- Generated by zebec https://github.com/ssoper/Zebec -->
    <meta charset='utf-8' />
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no' />
    <meta name='ICBM' content='39.0840, 77.1528' />
    <title>eat. code. stocks.</title>
    <link type='image/x-icon' href='/favicon.ico' rel='shortcut icon' />
    <link type='application/rss+xml' title='eat. code. stocks.' href='/blog/rss.xml' rel='alternate' />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js'></script>
      <script src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js'></script>
    <![endif]-->
  </head>
  <body>
    <!-- Navigation -->
    <nav class='navbar navbar-expand-lg navbar-dark bg-dark fixed-top'>
      <div class='container'>
        <a class='navbar-brand' title='eat. code. stocks.' href='/blog'>üç± üë®üèª‚Äçüíª üè¶</a>
        <button class='navbar-toggler' type='button' data-toggle='collapse' data-target='#navbarResponsive' aria-controls='navbarResponsive' aria-expanded='false' aria-label='Toggle navigation'>
          <span class='navbar-toggler-icon'></span>
        </button>
        <div class='collapse navbar-collapse' id='navbarResponsive'>
          <ul class='navbar-nav ml-auto'>
            <li class='nav-item'>
              <a class='nav-link' href='/'>Home</a>
            </li>
            <li class='nav-item'>
              <a class='nav-link' href='/blog'>Blog</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Page Content -->
    <div class='container'>
      <div class='row'>
        <div class='col-lg-8 content'>
          <h1 class='mt-4'>Using Retrofit to Integrate with an API</h1><h2 class='subtitle'>Building out a full-featured client complete with tests</h2><div class='author'>
  <img src='/images/avatar_normal.jpg' alt='' srcset='/images/avatar_normal.jpg 1x, /images/avatar_retina.jpg 2x'/>
  <ul>
    <li>Sean Soper</li>
    <li>January 27, 2021</li>
  </ul>
</div><img class='img-fluid rounded' alt='' src='//source.unsplash.com/EYKW9T91_zw/900x300' srcset='//source.unsplash.com/EYKW9T91_zw/900x300 1x, //source.unsplash.com/EYKW9T91_zw/1800x600 2x'><p>Integrating against an API involves a fair amount of work, especially if you want to do more than the bare minimum like including tests. Thanks to tools like <a href="https://medium.com/tompee/creating-your-own-http-api-wrapper-library-retrofit-2-bc86dfc11b1c">Retrofit</a>, <a href="https://medium.com/swlh/okhttp-interceptors-with-retrofit-2dcc322cc3f3">OkHttp</a> and their suite of plugins, this task becomes much more manageable.</p><blockquote><p>This post builds on work previously done in <a href="/blog/automating_retrieval_verifier_code_etrade.html">Automating the Retrieval of a Verifier Code from E*TRADE</a>.</p></blockquote><h2>Retrofit</h2><p>Per the previous work we‚Äôve done on building this E*TRADE client, OkHttp should already be included in the codebase. However, OkHttp acts to simply send or retrieve data over a network, it doesn‚Äôt try to transform it. That is where Retrofit comes in which plays nicely with OkHttp and offers a multitude of serializers. E*TRADE offers both XML and JSON format as does Retrofit but JSON is fairly standard so we will go with that using the well-known <a href="https://github.com/FasterXML/jackson">Jackson serializer</a>. We‚Äôll add these dependencies to our <code>build.gradle.kts</code>.</p><pre><code>
implementation(&quot;com.squareup.okhttp3:logging-interceptor:4.9.0&quot;)
implementation(&quot;com.squareup.retrofit2:retrofit:2.9.0&quot;)
implementation(&quot;com.squareup.retrofit2:converter-jackson:2.9.0&quot;)
</code></pre><p>To ensure every request has the appropriate header set so that JSON is returned, we will add a custom interceptor.</p><pre><code>
class JsonInterceptor: Interceptor {
    @Throws(IOException::class)
    override fun intercept(chain: Interceptor.Chain): Response {
        val original = chain.request()
        val request = original.newBuilder()
            .header(&quot;Accept&quot;, &quot;application/json&quot;)
            .build()
            
        return chain.proceed(request)
    }
} 
</code></pre><p>This interceptor will need to be referenced in the OkHttp client that we will be using. Note that both OkHttp and Retrofit make use of the <a href="https://www.baeldung.com/kotlin/builder-pattern">Builder pattern</a> which is common across Java and Kotlin libraries.</p><pre><code>
val client = OkHttpClient.Builder()
    .addInterceptor(EtradeInterceptor(keys))	            
    .addInterceptor(JsonInterceptor())
</code></pre><p>It‚Äôs also a good idea to add some logging and maybe put it behind a flag if only to help in debugging.</p><pre><code>
if (verbose) {
    val logger = HttpLoggingInterceptor()
    logger.level = HttpLoggingInterceptor.Level.BODY
    client.addInterceptor(logger)
}
</code></pre><p>The remaining work necessary to build the Retrofit client instance is somewhat dependent on the serialization library you‚Äôre using, such as Gson vs. Jackson, and expected date formats. This assumes Jackson is your serializer, that dates come back in an <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601 format</a> aka <code>HH:mm:ss zzz dd-MM-yyyy</code> and that you‚Äôre using a Gregorian calendar.</p><pre><code>
val module = SimpleModule()
module.addDeserializer(GregorianCalendar::class.java, DateSerializer.Decode())

val mapper = ObjectMapper()
mapper.dateFormat = SimpleDateFormat(&quot;HH:mm:ss zzz dd-MM-yyyy&quot;)
mapper.registerModule(module)
mapper.registerModule(KotlinModule())

val retrofit = Retrofit.Builder()
    .client(client.build())
    .baseUrl(baseUrl)
    .addConverterFactory(JacksonConverterFactory.create(mapper))
    .build()

val service = retrofit.create(Market::class.java)
val response = service.getQuote(symbol).execute()

return response.body()?.response?.data
</code></pre><h2>To Market, To Market</h2><p>The JSON returned from the call to the E*TRADE <code>market</code> endpoint looks like this (with a bunch of other data removed).</p><pre><code>
{
  &quot;QuoteResponse&quot;: {
    &quot;QuoteData&quot;: [
      {
        &quot;dateTime&quot;: &quot;11:41:00 EST 12-24-2020&quot;,
        &quot;dateTimeUTC&quot;: 1608828060,
        &quot;quoteStatus&quot;: &quot;REALTIME&quot;,
        &quot;All&quot;: {
          &quot;ask&quot;: 132.31,
          &quot;askSize&quot;: 600,
          &quot;askTime&quot;: &quot;11:41:00 EST 12-24-2020&quot;,
          &quot;bid&quot;: 132.29,
          &quot;companyName&quot;: &quot;APPLE INC COM&quot;,
        }
      }
    ]
  }
}
</code></pre><p>Starting with the outer structure we can create our model in Retrofit one layer at a time. This is our entrypoint.</p><pre><code>
interface Market {
    @GET(&quot;v1/market/quote/{symbol}&quot;)
    fun getQuote(@Path(&quot;symbol&quot;) symbol: String): Call&lt;TickerDataResponse&gt;
}
</code></pre><p>We can then add the three <code>data class</code> classes required to access the <code>All</code> key of the JSON response. Note that instead of using the default <code>All</code>, we can tell Retrofit to replace that key name with <code>tickerData</code> which sounds more logical. As well, <code>QuoteData</code> is actually an array so we will use a <code>List</code> type.</p><pre><code>
@JsonIgnoreProperties(ignoreUnknown = true)
data class QuoteData(
    val dateTime: GregorianCalendar,
    val quoteStatus: QuoteStatus,
    
    @JsonProperty(&quot;All&quot;)
    val tickerData: TickerData
)

@JsonIgnoreProperties(ignoreUnknown = true)
data class QuoteResponse(
    @JsonProperty(&quot;QuoteData&quot;)
    val data: List&lt;QuoteData&gt;
)

@JsonIgnoreProperties(ignoreUnknown = true)
data class TickerDataResponse(
    @JsonProperty(&quot;QuoteResponse&quot;)
    val response: QuoteResponse
)
</code></pre><h2>Serializing Dates</h2><p>Date serialization can be a tricky thing even when the library purports to support it. The documentation indicated that this could all be accomplished with annotations but that proved problematic. Since the returned dates all follow the same format, it makes sense to define it in just one place. This <code>DateSerializer</code> class was referenced when we created the Retrofit client.</p><pre><code>
object DateSerializer {
    private const val Format = &quot;HH:mm:ss zzz dd-MM-yyyy&quot;
    val Formatter = SimpleDateFormat(Format)
    
    class Encode: JsonSerializer&lt;GregorianCalendar&gt;() {
        @Throws(IOException::class, JsonProcessingException::class)
        override fun serialize(value: GregorianCalendar?, gen: JsonGenerator?, serializers: SerializerProvider?) {
            value?.apply {
                gen?.writeString(Formatter.format(time))
            }
        }
    }
    
    class Decode: JsonDeserializer&lt;GregorianCalendar&gt;() {
        @Throws(IOException::class, JsonProcessingException::class)
        override fun deserialize(p: JsonParser?, ctxt: DeserializationContext?): GregorianCalendar {
            return p?.text?.let {
                val date = Formatter.parse(it)
                val calendar = GregorianCalendar()
                calendar.time = date
                
                calendar
            } ?: throw DeserializerException()
        }
    }
    
    class DeserializerException: JsonProcessingException(&quot;Could not parse JSON&quot;)
}
</code></pre><h2>Enums</h2><p>The other really cool thing about Retrofit is that we can transform an item from a predefined set of values into a native enum value. We will use this to represent <code>QuoteStatus</code>.</p><pre><code>
enum class QuoteStatus {
    REALTIME, DELAYED, CLOSING, EH_REALTIME, EH_BEFORE_OPEN, EH_CLOSED, UNKNOWN
}
</code></pre><h2>Ticker Data</h2><p>Now that we‚Äôve unwrapped the response down to the final layer, it‚Äôs time to define the model for the actual ticker data being returned.</p><pre><code>
@JsonIgnoreProperties(ignoreUnknown = true)
data class TickerData(
    val adjustedFlag: Boolean?,           // Indicates whether an option has been adjusted due to a corporate action (for example, a dividend or stock split)
    val annualDividend: Float?,           // Cash amount paid per share over the past year
    val ask: Float?,                      // The current ask price for a security
    val askExchange: String?,             // Code for the exchange reporting the ask price
    ‚Ä¶
    val timeOfLastTrade: Int?,            // The time when the last trade was placed
    val averageVolume: Int?,              // Average volume value corresponding to the symbol
)
</code></pre><p>Ok so I actually cut out about 100 lines of code in that snippet but you can see the full model definition <a href="https://github.com/ssoper/Batil/pull/3/files#diff-e21a5eb98bd28187abe308dfe9b97cbc1f8e864b176ed3edcf5c9611f650ee19R59">here</a>. With that done however, we can now fully represent the E*TRADE response using Retrofit and start writing tests against it.</p><h2>Umm, Tests?</h2><p>So it‚Äôs kind of amazing we‚Äôve written this much code without once mentioning tests. At this point it seemed necessary though as the last thing you want to do is constantly hit an API when building out your model. Better to have a static response hosted locally that you can more quickly and easily validate changes against. Let‚Äôs add the following to our <code>build.gradle.kts</code>.</p><pre><code>
testImplementation(&quot;io.kotlintest:kotlintest-runner-junit5:3.4.2&quot;)
testImplementation(&quot;com.squareup.okhttp3:mockwebserver:4.9.0&quot;)
</code></pre><p>This will need to be added to the root.</p><pre><code>
tasks.withType&lt;Test&gt; {
    useJUnitPlatform()
}
</code></pre><p>With OkHttp‚Äôs <code>MockWebServer</code> we can serve up JSON responses to validate unit tests. Let‚Äôs take the JSON response from one of these calls and save it in a file called <code>single_ticker_success.json</code> somewhere under <code>test/resources</code>. To make loading of these JSON responses easy, I‚Äôve added a convenience class <code>MockResponseFile</code>.</p><pre><code>
class MockResponseFile(path: String) {
    val content: String
    
    init {
        val reader = InputStreamReader(this.javaClass.classLoader.getResourceAsStream(path)!!)
        content = reader.readText()
        reader.close()
    }
}
</code></pre><p>We‚Äôll want to create our actual test in a file called <code>EtradeTest.kt</code> under <code>test/kotlin</code>.</p><pre><code>
class EtradeTest: StringSpec({
    val config = LoadConfig().content
    
    &quot;single ticker&quot; {
        val server = MockWebServer()
        server.start()
        
        val content = MockResponseFile(&quot;single_ticker_success.json&quot;).content
        content.shouldNotBeNull()
        
        val response = MockResponse()
            .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)
            .setBody(content)
        server.enqueue(response)
        
        val client = Etrade(config, baseUrl = it.url(&quot;.&quot;).toString())
        val oauth = EtradeAuthResponse(&quot;token&quot;, &quot;secret&quot;)
        val data = client.ticker(&quot;AAPL&quot;, oauth, &quot;verifierCode&quot;)
        
        data.shouldNotBeNull()
        data.tickerData.shouldNotBeNull()
        data.tickerData.symbolDescription.shouldBe(&quot;APPLE INC COM&quot;)
        server.takeRequest().path.shouldBe(&quot;/v1/market/quote/AAPL&quot;)            
        
        server.close()
    }
})
</code></pre><p>This test uses OkHttp to setup a temporary server instance on your local machine which will <em>only</em> return the JSON specified when accessed. Once the data has been returned it can be checked, the request path verified and finally the server shut down.</p><h2>Converting API Documentation to Kotlin</h2><p>The E*TRADE API is a fairly large API with lots of hierarchy. Going through it line by line on a website and replicating it in Kotlin seemed like a pretty tall order so I created a small script to make it easier. I thought it would take no more than an hour but many hours later, after fruitlessly searching for my compiler textbooks from college, I came up with something that did the trick and didn‚Äôt require <a href="http://dinosaur.compilertools.net/">lex, yacc or bison</a>. Instead it uses <code>sed</code>, <code>sort</code> and a handful of other tools provided by bash. You can find the full implementation <a href="https://github.com/ssoper/Batil/pull/3/files#diff-790671999cfa750dfd2233f1d4a750ffbee0e973e27be32e78d25bc9cf598fbdR1">here</a>. Perhaps you can find it useful in other contexts.</p><h2>Summary</h2><p>Retrofit, OkHttp and their suite of plugins make API integration much easier. Having tests reduces the chances of introducing bugs when changing your implementation. They also add a sanity check in case the API changes underneath you.</p><p>A summary of these commits can be found <a href="https://github.com/ssoper/Batil/pull/3/files">here</a>.</p>
        </div>
        <!-- Sidebar Widgets Column -->
        <div class='col-md-4'>
          <!-- Search Widget -->
          <div class='card my-4'>
            <h5 class='card-header'>Search</h5>
            <div class='card-body'>
              <div class='input-group'>
                <input class='form-control' placeholder='Search for‚Ä¶' id='search-query' type='text' />
                <span class='input-group-btn'>
                  <button class='btn btn-secondary' type='button' id='search-button'>Go!</button>
                </span>
              </div>
            </div>
          </div>
          <a href='/blog/rss.xml'><img width='72' src='https://shields.io/badge/rss-2.0-blue?logo=rss'></a>
        </div>
      </div>
    </div>
    <!-- jQuery -->
    <script integrity='sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n' crossorigin='anonymous' src='https://code.jquery.com/jquery-3.4.1.slim.min.js'></script>
    <!-- Popper -->
    <script integrity='sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo' crossorigin='anonymous' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
    <!-- Bootstrap -->
    <script integrity='sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6' crossorigin='anonymous' src='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js'></script>
    <!-- highlight.js -->
    <script src='//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js'></script>
    <!-- Delay loading of some assets for Google PageSpeed optimizations -->
    <noscript id='deferred-styles'>
      <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' integrity='sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh' crossorigin='anonymous' rel='stylesheet' />
      <link href='/css/blog.min.css' rel='stylesheet' />
      <link href='//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/default.min.css' rel='stylesheet' />
    </noscript>
    <script src='/js/load_deferred_styles.min.js'></script>
    <script src='/js/load_highlight.min.js'></script>
    <script src='/js/load_search.min.js'></script>
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    if (typeof(ga) === 'function') { ga('create', 'UA-616637-1', 'auto'); ga('send', 'pageview'); }
    </script>
  </body>
</html>