<!doctype html>
<html lang='en'>
  <head>
    <meta name='twitter:card' content='summary' />
    <meta property='og:title' content='Storing Secrets Securely in Kotlin' />
    <meta property='og:url' content='https://seansoper.com/blog/storing_secrets_securely_kotlin.html' />
    <meta property='og:description' content='It‚Äôs not uncommon for applications to occasionally need to store secrets. The security of those secrets relies partly on the underlying cryptography and partly on the layout of the scheme. In this implementation, we will provide sensible defaults using dependency injection to simplify both testing and deployment to a production-ready system.' />
    <meta property='og:image' content='//source.unsplash.com/L4hg5o67jdw/1200x627' />
    <!-- Generated by zebec https://github.com/ssoper/Zebec -->
    <meta charset='utf-8' />
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no' />
    <meta name='ICBM' content='39.0840, 77.1528' />
    <title>eat. code. stocks.</title>
    <link type='image/x-icon' href='/favicon.ico' rel='shortcut icon' />
    <link type='application/rss+xml' title='eat. code. stocks.' href='/blog/rss.xml' rel='alternate' />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js'></script>
      <script src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js'></script>
    <![endif]-->
  </head>
  <body>
    <!-- Navigation -->
    <nav class='navbar navbar-expand-lg navbar-dark bg-dark fixed-top'>
      <div class='container'>
        <a class='navbar-brand' title='eat. code. stocks.' href='/blog'>üç± üë®üèª‚Äçüíª üè¶</a>
        <button class='navbar-toggler' type='button' data-toggle='collapse' data-target='#navbarResponsive' aria-controls='navbarResponsive' aria-expanded='false' aria-label='Toggle navigation'>
          <span class='navbar-toggler-icon'></span>
        </button>
        <div class='collapse navbar-collapse' id='navbarResponsive'>
          <ul class='navbar-nav ml-auto'>
            <li class='nav-item'>
              <a class='nav-link' href='/'>Home</a>
            </li>
            <li class='nav-item'>
              <a class='nav-link' href='/blog'>Blog</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Page Content -->
    <div class='container'>
      <div class='row'>
        <div class='col-lg-8 content'>
          <h1 class='mt-4'>Storing Secrets Securely in Kotlin</h1><h2 class='subtitle'>Building a simple key store using standard Java cryptography libraries</h2><div class='author'>
  <img src='/images/avatar_normal.jpg' alt='' srcset='/images/avatar_normal.jpg 1x, /images/avatar_retina.jpg 2x'/>
  <ul>
    <li>Sean Soper</li>
    <li>February 21, 2021</li>
  </ul>
</div><img class='img-fluid rounded' alt='' src='//source.unsplash.com/L4hg5o67jdw/900x300' srcset='//source.unsplash.com/L4hg5o67jdw/900x300 1x, //source.unsplash.com/L4hg5o67jdw/1800x600 2x'><p>It‚Äôs not uncommon for applications to occasionally need to store secrets. The security of those secrets relies partly on the underlying cryptography and partly on the layout of the scheme. In this implementation, we will provide sensible defaults using <a href="https://medium.com/better-programming/kotlin-and-the-simplest-dependency-injection-tutorial-ever-b437d8c338fe">dependency injection</a> to simplify both testing and deployment to a production-ready system.</p><blockquote><p>This post references work previously done in <a href="/blog/using_retrofit_integrate_api.html">Using Retrofit to Integrate with an API</a>.</p></blockquote><h2>KeyStore</h2><p>We will be making use of the <a href="https://docs.oracle.com/javase/7/docs/api/java/security/KeyStore.html">KeyStore</a> class which offers three methods for storing secrets. Let‚Äôs go to the documentation.</p><ul><li><code>PrivateKeyEntry</code> ‚Äì This type of entry holds a cryptographic <code>PrivateKey</code>, which is optionally stored in a protected format to prevent unauthorized access. It is also accompanied by a certificate chain for the corresponding public key.</li><li><code>TrustedCertificateEntry</code> ‚Äì This type of entry contains a single public key <code>Certificate</code> belonging to another party. It is called a trusted certificate because the keystore owner trusts that the public key in the certificate indeed belongs to the identity identified by the subject (owner) of the certificate.</li><li><code>SecretKeyEntry</code> ‚Äì This type of entry holds a cryptographic <code>SecretKey</code>, which is optionally stored in a protected format to prevent unauthorized access.</li></ul><p>Since our needs are pretty basic we can get what we need out of the last option, <code>SecretKeyEntry</code>, without the hassle of having to deal with any certificates. We will store our secrets on the filesystem and the structure will look like this.</p><pre><code>
/Users/home_dir
  ‚îî‚îÄ‚îê.keystore_dir
     ‚îú‚îÄ key.password
     ‚îî‚îÄ key.store
</code></pre><p>The <code>key.password</code> is where we will store the password that can lock or unlock our secrets. Ideally, in a production system it should be located in a different directory than the <code>key.store</code> which holds our actual secrets.</p><h2>Keeping Secrets</h2><p>Let‚Äôs start with a <code>Secrets</code> class and the functionality to retrieve the file or create it if it doesn‚Äôt exist.</p><pre><code>
class Secrets(private val keyStorePath: Path = Paths.get(System.getProperty(&quot;user.home&quot;), &quot;.secrets&quot;, &quot;key.store&quot;),
              private val passwordPath: Path = Paths.get(System.getProperty(&quot;user.home&quot;), &quot;.secrets&quot;, &quot;key.password&quot;)) {

    private val keyStoreFile: File
        get() {
            val dirPath = keyStorePath.parent
          
            if (!dirPath.toFile().exists()) {
                dirPath.toFile().mkdirs()
            }
          
            return keyStorePath.toFile()
        }
    }
    
}
</code></pre><p>Now we‚Äôll want to load the contents of that file into a <code>KeyStore</code> or return a null entry.</p><pre><code>
private val keyStore: KeyStore by lazy {
    val keyStore = KeyStore.getInstance(KeyStore.getDefaultType())
  
    if (keyStoreFile.exists()) {
       val stream = FileInputStream(keyStoreFile)
       try {
           keyStore.load(stream, password)
       } catch (exception: java.io.IOException) {
           throw CachedTokenException(keyStorePath)
       }
    } else {
       keyStore.load(null, password)
    }
  
    keyStore
}
</code></pre><p>We‚Äôll also want a means of saving and retrieving our password that can lock and unlock the store. If the password file doesn‚Äôt exist then we will generate a new password using <code>UUID.randomUUID()</code> and save that as our password.</p><pre><code>
private val password: CharArray by lazy {
    val dirPath = passwordPath.parent
    if (!dirPath.toFile().exists()) {
        dirPath.toFile().mkdirs()
    }
  
    val path = passwordPath.toFile()
  
    if (path.exists()) {
        path.readText().toCharArray()
    } else {
        val uuid = UUID.randomUUID().toString()
        path.writeText(uuid)
        uuid.toCharArray()
    }
}
</code></pre><p>Note that both of these properties make use of the <a href="https://kotlinlang.org/docs/delegated-properties.html#lazy-properties">lazy</a> keyword which means they aren‚Äôt computed until after first access. And once computed, the results are remembered so they don‚Äôt have to be computed again, useful for operations like loading data out of a file. As well, <code>lazy</code> getters don‚Äôt require a return statement since they are technically a lambda of type <code>Lazy&lt;T&gt;</code>.</p><h2>Retrieve Entries</h2><p>With the basics of our <code>KeyStore</code> and password handled, retrieving entries becomes fairly simple. Note however that the <code>getEntry</code> method on <code>KeyStore</code> is incorrectly marked as non-nullable. That means we need to use an old fashioned null check instead of an optional.</p><pre><code>
fun getEntry(entry: String): String? {
    if (!keyStoreFile.exists()) {
        return null
    }
    
    val protection = KeyStore.PasswordProtection(password)
    val secret = keyStore.getEntry(entry, protection)
    
    return if (secret != null) {
        String((secret as KeyStore.SecretKeyEntry).secretKey.encoded)
    } else {
        null
    }
}
</code></pre><h2>Save Entries</h2><p>Adding the ability to save entries is the last bit of functionality we need.</p><pre><code>
fun setEntry(entry: String, value: String) {
    val protection = KeyStore.PasswordProtection(password)
    val encoded = SecretKeySpec(value.toByteArray(), &quot;AES&quot;)
    
    keyStore.setEntry(entry, KeyStore.SecretKeyEntry(encoded), protection)
    
    val stream = FileOutputStream(keyStoreFile)
    stream.use {
        keyStore.store(it, password)
    }
}
</code></pre><p>We can also add a nice little convenience function for quickly clearing the store if need be.</p><pre><code>
fun destroy() {
    Files.deleteIfExists(keyStorePath)
    Files.deleteIfExists(passwordPath)
}
</code></pre><h2>Summary</h2><p>With our simple key store, we can quickly retrieve and save values that we‚Äôd prefer to remain secret. Unit testing this functionality isn‚Äôt difficult either through the use of temporary directories. While this implementation avoids any references to the E*TRADE API, saving API keys is precisely why I created it.</p><p>A summary of these commits can be found <a href="https://github.com/ssoper/Batil/pull/7/files">here</a>.</p>
        </div>
        <!-- Sidebar Widgets Column -->
        <div class='col-md-4'>
          <!-- Search Widget -->
          <div class='card my-4'>
            <h5 class='card-header'>Search</h5>
            <div class='card-body'>
              <div class='input-group'>
                <input class='form-control' placeholder='Search for‚Ä¶' id='search-query' type='text' />
                <span class='input-group-btn'>
                  <button class='btn btn-secondary' type='button' id='search-button'>Go!</button>
                </span>
              </div>
            </div>
          </div>
          <a href='/blog/rss.xml'><img width='72' src='https://shields.io/badge/rss-2.0-blue?logo=rss'></a>
        </div>
      </div>
    </div>
    <!-- jQuery -->
    <script integrity='sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n' crossorigin='anonymous' src='https://code.jquery.com/jquery-3.4.1.slim.min.js'></script>
    <!-- Popper -->
    <script integrity='sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo' crossorigin='anonymous' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
    <!-- Bootstrap -->
    <script integrity='sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6' crossorigin='anonymous' src='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js'></script>
    <!-- highlight.js -->
    <script src='//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js'></script>
    <!-- Delay loading of some assets for Google PageSpeed optimizations -->
    <noscript id='deferred-styles'>
      <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' integrity='sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh' crossorigin='anonymous' rel='stylesheet' />
      <link href='/css/blog.min.css' rel='stylesheet' />
      <link href='//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/default.min.css' rel='stylesheet' />
    </noscript>
    <script src='/js/load_deferred_styles.min.js'></script>
    <script src='/js/load_highlight.min.js'></script>
    <script src='/js/load_search.min.js'></script>
    <!-- Google Analytics -->
    <script async src='https://www.googletagmanager.com/gtag/js?id=UA-616637-1'></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-616637-1');
    </script>
  </body>
</html>